<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1, maximum-scale=1">
	<title>AIM SOLO School Project</title>
	
	<link rel="stylesheet" href="css/themes/aim-solo.min.css"/>
	<link rel="stylesheet" href="css/themes/jquery.mobile.icons.min.css" />
	<link rel="stylesheet" href="jquery.mobile.structure-1.4.5.min.css" />
	<script src="http://code.jquery.com/jquery-1.11.1.min.js"></script>
	<script src="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
	<!-- <script type="text/javascript" src="js/jquery.i18n.js"></script> -->
	<script id="panel-init">
		$(function() {
			$( "body>[data-role='panel']" ).panel();
		});
	</script>
</head>

<body>
	<style>
		div[data-role=popup]{
			background-color:white;
		}
		
		body {
		background:url(background.jpg);
		background-color:#004063;
		background-repeat:no-repeat;
		background-position:crop;
		background-attachment:fixed;
		background-size:100%;
		}
		.ui-page {
		background: transparent;
		}
		.ui-content{
		background: transparent;
		}
		
		.splash {
		background-repeat:no-repeat;
		background-position:crop;
		background-attachment:fixed;
		background-size:75%;
		background-position: center;
		text-align: center;
		}
	</style>
	
	<div data-role="popup" id="logout-popup" data-overlay-theme="b" data-theme="b" style="max-width:400px;">
		<center>
			<div role="main" class="ui-content" style="max-width:85%;">
				<a href="#" data-rel="back" class="ui-btn ui-corner-all ui-shadow ui-btn-a ui-icon-delete ui-btn-icon-notext ui-btn-right"></a>
				<h3 class="ui-title" data-text="VoleuTancarLaSessio">Voleu tancar la vostra sessió?</h3>
				<p data-text="TextTancarSessio">Sereu redirigits a la pàgina d'inici de sessió de l'aplicació.</p>
				<br/>
				<a class="ui-btn ui-corner-all si-logout" data-text="TancarSessio" style="width:50%;background-color:red;color:white">Tancar la sessió</a>
				<br/>
	    	</div>
		</center>
	</div>
	
	<!-- SPLASHCREEN -->
	<div data-role="page" id="splash" class="splash" style="background-image: url('logo.png');"> 
		<div class="splash2">
		</div>
	</div>
	
	<!-- LOGIN PAGE -->
	<div data-role="page" id="login-page">

		<div data-role="header">
			<h1 data-text="login title"></h1>
		</div>

		<div data-role="main" class="ui-content">
			<form id="login-form" method="get">
				<input id="username" type="text" placeholder="E-mail"/>
				<input id="pwd" type="password" placeholder="Password"/>
				<button type="submit" data-icon="user" data-text="Login"></button>
			</form>
		</div>
		
		<!-- <button id="recorder">Recorder</button> -->
		<!-- <button id="diamond">Matt Diamond</button> -->
		<!-- <br/><br/> -->
		<!-- <center><iframe src="https://192.168.1.111/proves/asapp/recorder/new1.html"></iframe></center> -->
		<!-- <div data-role="footer">
			<h4>Aim Solo School Project</h4>
		</div> -->

	</div>

	<!-- PROJECT PAGE -->
	<div data-role="page" id="projects-page">
	

		<div data-role="header" data-position="inline">
			<h1>#hashtag</h1>
			<a href="#" type="button" class="goback_btn ui-btn-icon-notext" data-icon="back" data-text="Tornar" style="visibility:hidden">Tornar</a>
			<a href="#rightpanel" data-rel="panel" class="ui-btn ui-icon-bars ui-btn-icon-notext" style="background-color:#186792; border-color:#186792; color=#3dc3ef" data-text="Menu">Menú</a>
		</div>
		<div data-role="main" class="ui-content">
		<center><h4 data-text="Projectes">Projectes</h4></center>
		<hr>
		<ul data-role="listview" data-inset="true" id="project-list">
		</ul>
		</div>

		<!-- <div data-role="footer">
			<h4>Aim Solo School Project</h4>
		</div> -->

	</div><!-- /page -->

	<!-- STUDENTS PAGE -->
	<div data-role="page" id="students-page">
	
		<div data-role="header">
			<h1>#hashtag</h1>
			<a href="#" class="ui-btn ui-icon-back goback_btn ui-btn-icon-notext" style="background-color:#186792; border-color:#186792; color=#3dc3ef" data-text="Tornar">Tornar</a>
			<a href="#rightpanel" data-rel="panel" type="button" class="ui-btn ui-icon-bars ui-btn-icon-notext" style="background-color:#186792; border-color:#186792; color=#3dc3ef" data-text="Menu">Menú</a>
		</div>

		<div data-role="main" class="ui-content">
		<center><h4>Estudiants</h4></center>
		<hr>
		<ul data-role="listview" data-inset="true" id="student-list">
		</ul>
		</div>

		<!-- <div data-role="footer">
			<h4>Aim Solo School Project</h4>
		</div> -->

	</div><!-- /page -->

	<!-- SELECTOR PAGE -->
	<div data-role="page" id="selector-page">

		<div data-role="header">
			<h1>#hashtag</h1>
			<a href="#" class="ui-btn ui-icon-back goback_btn ui-btn-icon-notext" style="background-color:#186792; border-color:#186792; color=#3dc3ef" data-text="Tornar">Tornar</a>
			<a href="#rightpanel" data-rel="panel" type="button" class="ui-btn ui-icon-bars ui-btn-icon-notext logout_btn" style="background-color:#186792; border-color:#186792; color=#3dc3ef" data-text="Menu">Menú</a>
		</div>

		<div data-role="main" class="ui-content">
		<center><h4>Pàgina de</h4></center>
		<hr>
			<a href="#intels-page" data-role="button" data-text="Intels">Intel·ligències</a>
			<a href="#comps-page" data-role="button" data-text="Comps">Competències</a>
			<a href="#comps_millora-page" data-role="button" data-text="Comps_millora">Competències de millora</a>
			<a href="#emocions-page" data-role="button" data-text="Emocions">Emocions</a>
		</div>
	

	</div><!-- /page -->
	
	<!-- COMPS PAGE -->
	<div data-role="page" id="comps-page">


		<div data-role="header">
			<h1>#hashtag</h1>
			<a href="#" class="ui-btn ui-icon-back goback_btn ui-btn-icon-notext" style="background-color:#186792; border-color:#186792; color=#3dc3ef" data-text="Tornar">Tornar</a>
			<a href="#rightpanel" data-rel="panel" class="ui-btn ui-icon-bars ui-btn-icon-notext" style="background-color:#186792; border-color:#186792; color=#3dc3ef" data-text="Menu">Menú</a>
		</div>

		<div data-role="main" class="ui-content">
		<center><h4>Competències</h4></center>
		<hr>
		<form align="center">
  				<fieldset data-role="controlgroup" data-type="horizontal" id="filter-cg">
 					<input type="checkbox" data-id="dd" id="checkbox-"><label for="checkbox-" >Grups</label>
  				</fieldset>
  			</form>
  			<ul data-role="listview" data-filter="true" data-filter-placeholder="Buscar competència" data-autodividers="true" data-inset="true" id="comps-list">
 			</ul>
 		</div>

		<!-- <div data-role="footer">
			<h4>Aim Solo School Project</h4>
		</div> -->
		
		
		<center>
		<div data-rel="popup" data-role="popup" id="comps-popup" align="center" data-theme="b">
			<p></p>
			<form align="center">
				<fieldset data-role="controlgroup" data-type="horizontal">
					<button type="button" id="no-comp" data-icon="delete" data-text="No"></button>
					<button type="button" id="si-comp" data-icon="check" data-text="Sí"></button>
				</fieldset>
			</form>
		</div>
		</center>
					
		<div data-role="footer" id="comps-footer" data-id="main-footer" style="background-color:green;border-color:green" data-position="fixed">
			<center><button id="comps-update" style="border-color:green;background-color:green;color:white" class="ui-btn ui-icon-check ui-btn-icon-left ui-shadow-icon" data-text="CompActualitzada">La competència s'ha actualitzat correctament</a></center>
		</div>
	
	</div>
	
	<!-- COMPS_MILLORA PAGE -->
	<div data-role="page" id="comps_millora-page">

		<div data-role="header">
			<h1>#hashtag</h1>
			<a href="#" class="ui-btn ui-icon-back goback_btn ui-btn-icon-notext" style="background-color:#186792; border-color:#186792; color=#3dc3ef" data-text="Tornar">Tornar</a>
			<a href="#rightpanel" data-rel="panel" class="ui-btn ui-icon-bars ui-btn-icon-notext" style="background-color:#186792; border-color:#186792; color=#3dc3ef" data-text="Menu">Menú</a>
		</div>

		<div data-role="main" class="ui-content">
		<center><h4>Competències de millora</h4></center>
		<hr>
			<ul data-role="listview" data-filter="true" data-filter-placeholder="Buscar competència" data-autodividers="true" data-inset="true" id="comps_millora-list">
			</ul>
		</div>

		<!-- <div data-role="footer">
			<h4>Aim Solo School Project</h4>
		</div> -->
	
		<div data-rel="popup" data-role="popup" id="comps_millora-popup" align="center" data-theme="b">
			<p></p>
			<form align="center">
				<fieldset data-role="controlgroup" data-type="horizontal">
					<button type="button" id="no-comp_millora" data-icon="delete">No</button>
					<button type="button" id="si-comp_millora" data-icon="check">Sí</button>
				</fieldset>
			</form>
		</div>
	
		
			
	<div data-role="footer" id="comp_millora-footer" data-id="main-footer" style="background-color:green;border-color:green" data-position="fixed">
		<center><button id="comp_millora-update" style="border-color:green;background-color:green;color:white" class="ui-btn ui-icon-check ui-btn-icon-left ui-shadow-icon" data-text="CompActualitzada">La competència s'ha actualitzat correctament</a></center>
	</div>
	

	</div><!-- /page -->
	
	<!-- INTELS PAGE -->
	<div data-role="page" id="intels-page">

		<div data-role="header">
			<h1>#hashtag</h1>
			<a href="#" class="ui-btn ui-icon-back goback_btn ui-btn-icon-notext" style="background-color:#186792; border-color:#186792; color=#3dc3ef" data-text="Tornar">Tornar</a>
			<a href="#rightpanel" data-rel="panel" class="ui-btn ui-icon-bars ui-btn-icon-notext" style="background-color:#186792; border-color:#186792; color=#3dc3ef" data-text="Menu">Menú</a>
		</div>

		<div data-role="main" class="ui-content">
		<center><h4>Intel·ligències</h4></center>
		<hr>
		
			<label data-text="Corporal" style="font-weight: bold;float:left; padding-right:2px"></label><label for="slider-corporal" style="float:left"><span id="span-corporal"></span></label>
			<input data-mini="true" class="intel-slider" type="range" data-id_intel="1" data-levels="Baix|Mig baix|Mig|Mig alt|Alt|Molt alt" data-highlight="true" id="slider-corporal" min="-2" max="3" value="0" >
			<br/><br/>
			<label data-text="Emocional" style="font-weight: bold;float:left; padding-right:2px"></label> <label for="slider-corporal" style="float:left"><span id="span-corporal"></span></label>
			<input data-mini="true" class="intel-slider" type="range" data-id_intel="2" data-levels="Baix|Mig baix|Mig|Mig alt|Alt|Molt alt" data-highlight="true" id="slider-" min="-2" max="3" value="0" >
			<br/><br/>
			<label data-text="Espacial" style="font-weight: bold;float:left; padding-right:2px"></label> <label for="slider-corporal" style="float:left"><span id="span-corporal"></span></label>
			<input data-mini="true" class="intel-slider" type="range" data-id_intel="3" data-levels="Baix|Mig baix|Mig|Mig alt|Alt|Molt alt" data-highlight="true" id="slider-" min="-2" max="3" value="0" >
			<br/><br/>
			<label for="slider-corporal" style="float:left"><span id="span-corporal"></span></label>
			<input data-mini="true" class="intel-slider" type="range" data-id_intel="4" data-levels="Interpersonal no contributiva: Molt alta|Interpersonal no contributiva: Alta|Interpersonal no contributiva: Mig alta|Interpersonal no contributiva: Centrada|Interpersonal contributiva: Centrada|Interpersonal contributiva: Mig alta|Interpersonal contributiva: Alta|Interpersonal contributiva: Molt alta" data-highlight="true" id="slider-interpersonal" min="0" max="7" value="0" >
			<br/><br/>
			<label data-text="Intrapersonal" style="font-weight: bold;float:left; padding-right:2px"></label> <label for="slider-corporal" style="float:left"><span id="span-corporal"></span></label>
			<input data-mini="true" class="intel-slider" type="range" data-id_intel="5" data-levels="Baix|Mig baix|Mig|Mig alt|Alt|Molt alt" data-highlight="true" id="slider-" min="-2" max="3" value="0" >
			<br/><br/>
			<label data-text="Musical" style="font-weight: bold;float:left; padding-right:2px"></label> <label for="slider-corporal" style="float:left"><span id="span-corporal"></span></label>
			<input data-mini="true" class="intel-slider" type="range" data-id_intel="6" data-levels="Baix|Mig baix|Mig|Mig alt|Alt|Molt alt" data-highlight="true" id="slider-" min="-2" max="3" value="0" >
			<br/><br/>
			<label data-text="Numerica" style="font-weight: bold;float:left; padding-right:2px"></label> <label for="slider-corporal" style="float:left"><span id="span-corporal"></span></label>
			<input data-mini="true" class="intel-slider" type="range" data-id_intel="7" data-levels="Baix|Mig baix|Mig|Mig alt|Alt|Molt alt" data-highlight="true" id="slider-" min="-2" max="3" value="0" >
			<br/><br/>
			<label data-text="RaonamentLogic" style="font-weight: bold;float:left; padding-right:2px"></label> <label for="slider-corporal" style="float:left"><span id="span-corporal"></span></label>
			<input data-mini="true" class="intel-slider" type="range" data-id_intel="8" data-levels="Baix|Mig baix|Mig|Mig alt|Alt|Molt alt" data-highlight="true" id="slider-" min="-2" max="3" value="0" >
			<br/><br/>
			<label data-text="Verbal" style="font-weight: bold;float:left; padding-right:2px"></label> <label for="slider-corporal" style="float:left"><span id="span-corporal"></span></label>
			<input data-mini="true" class="intel-slider" type="range" data-id_intel="9" data-levels="Baix|Mig baix|Mig|Mig alt|Alt|Molt alt" data-highlight="true" id="slider-" min="-2" max="3" value="0" >
			<br/><br/>
			<label data-text="Visual" style="font-weight: bold;float:left; padding-right:2px"></label> <label for="slider-corporal" style="float:left"><span id="span-corporal"></span></label>
			<input data-mini="true" class="intel-slider" type="range" data-id_intel="10" data-levels="Baix|Mig baix|Mig|Mig alt|Alt|Molt alt" data-highlight="true" id="slider-" min="-2" max="3" value="0" >
		</div>
	</div><!-- /page -->
	
	<!-- EMOCIONS PAGE -->
	<div data-role="page" id="emocions-page">


		<div data-role="header">
			<h1>#hashtag</h1>
			<a href="#" class="ui-btn ui-icon-back goback_btn ui-btn-icon-notext" style="background-color:#186792; border-color:#186792; color=#3dc3ef" data-text="Tornar">Tornar</a>
			<a href="#rightpanel" data-rel="panel" class="ui-btn ui-icon-bars ui-btn-icon-notext" style="background-color:#186792; border-color:#186792; color=#3dc3ef" data-text="Menu">Menú</a>
		</div>

		<div data-role="main" class="ui-content">
		<center><h4>Emocions</h4></center>
		<hr>
			<ul data-role="listview" data-filter="true" data-filter-placeholder="Buscar emoció" data-inset="true" id="emocions-list">
			</ul>
		</div>

		<center>
		<div data-rel="popup" data-role="popup" id="emocions-popup" align="center" data-theme="b">
			<p></p>
			<form align="center">
				<fieldset data-role="controlgroup" data-type="horizontal">
					<button type="button" id="no-emocions" data-icon="delete" data-text="No"></button>
					<button type="button" id="si-emocions" data-icon="check" data-text="Sí"></button>
				</fieldset>
			</form>
		</div>
		</center>
		
		
			
		<div data-role="footer" id="footer-emocions" data-id="main-footer" style="background-color:green;border-color:green" data-position="fixed">
		<center><button id="emocions-update" style="border-color:green;background-color:green;color:white" class="ui-btn ui-icon-check ui-btn-icon-left ui-shadow-icon" data-text="CompActualitzada">La competència s'ha actualitzat correctament</a></center>
		</div>
	
	</div>
	
	<!-- rightpanel  -->
	<div data-role="panel" id="rightpanel" data-position="right" data-display="overlay" style="background-color:rgba(24, 103, 146, 0.9)">
		<center><h3 style="color:white">AS EduComp</h3></center><br/>
		<button type="button" onClick="sync()" style="border-color:rgba(24, 103, 146, 0.0);background-color:rgba(24, 103, 146, 0.0);color:white" class="ui-btn ui-corner-all ui-btn-a ui-icon-refresh ui-btn-icon-left ui-btn-inline" data-text="Sincronitzar"></button>
		<a href="#projects-page" data-rel="change" style="border-color:rgba(24, 103, 146, 0.0);background-color:rgba(24, 103, 146, 0.0);color:white" class="ui-btn ui-corner-all ui-btn-a ui-icon-bullets ui-btn-icon-left ui-btn-inline" data-text="CanviarProjecte"></a>
		<a href="#logout-popup" data-rel="popup" style="border-color:rgba(24, 103, 146, 0.0);background-color:rgba(24, 103, 146, 0.0);color:white" class="ui-btn ui-corner-all ui-btn-a ui-icon-power ui-btn-icon-left ui-btn-inline" data-text="Tancar"></a>
	</div><!-- /rightpanel1 -->
	
</body>
</html>

<script>
var domini_com = 'https://comunitat.aim-solo.com/';
var domini_intra = 'https://intra.aim-solo.com/schools';
var user_name;
var user_id;
var entitat_id;
var project_id;
var project_name;
var student_id;
var student_name;
var student_sex;
var comps_masc;
var comps_fem;
var comps_millora;
var comp_name;
var comp_id;
var nstudents;
var nprojects;
var comps_groups = null;// = [{'id':1,'name':"Societat"}, {'id':2,'name':"Professional"}, {'id':3,'name':"Excel·lència"}];
var current_groups = [];
var i18n;
var emocions;
var lang = 'cat';


$(document).on('ready',function(){
	$('#logout-popup').popup();
	$('#success-popup').popup();
	$("#footer").hide();
	$("#footer-emocions").hide();
	$("#comps-footer").hide();
	$("#comp_millora-footer").hide();

	{ // Gestionem traduccions
		$.getJSON("i18n/i18n.json", function(json) {
			i18n = json;
			{ // Recorrem translatables
				$("[data-text]").each(function(){
					text = __($(this).data("text"));
					$(this).text(text);
				});
			}
			{ // Recorrem placeholders
				$("[placeholder]").each(function(){
					$(this).attr('placeholder',__($(this).attr('placeholder')));
				});
			}
			{ // Recorrem 2ns placeholders
				$("[data-filter-placeholder]").each(function(){
					$(this).attr('data-filter-placeholder',__($(this).attr('data-filter-placeholder')))
				});
			}
			{ // Recorrem nivells slides
				$("[data-levels]").each(function(){
					$(this).attr('data-levels',__($(this).attr('data-levels')))
				});
			}
			
			// Els events del loading han d'estar al callback del getJSON pq contenen strings
			$( document ).ajaxStart(function() {
				$.mobile.loading( "show", {
					text: __("UnMoment"),
					textVisible: true,
					theme: 'a',
					textonly: false
				});
			});

			$( document ).ajaxStop(function() {
				$.mobile.loading( "hide" );
			});
		});
	}
	
});


$("#recorder").click(function() {
	window.location.href="recorder.html";
});

$("#diamond").click(function() {
	window.location.href="recorder/new1.html";
});

{ //Splash screen
	{ // Carreguem variables de la memòria local
		user_id = localStorage.getItem('user_id');
		user_name = localStorage.getItem('user_name');
		entitat_id = localStorage.getItem('entitat_id');
		project_id = localStorage.getItem('project_id');
		project_name = localStorage.getItem('project_name');
		comps_masc = JSON.parse(localStorage.getItem('comps_masc'));
		comps_fem = JSON.parse(localStorage.getItem('comps_fem'));
		comps_millora = JSON.parse(localStorage.getItem('comps_millora'));
		comps_groups = JSON.parse(localStorage.getItem('comps_groups'));
		emocions = JSON.parse(localStorage.getItem('emocions'));
	}
	
	$( "#splash" ).on( "pageshow", function( e ) {
		setTimeout(function() {
			if ((user_id != null) || (user_name != null)) {
				$.mobile.changePage("#projects-page", "fade");
			}
			else {
				$.mobile.changePage("#login-page", "fade");
			}
		}, 2000);
	})
}

{ // Login page
		
	$('#login-form').submit(function(e) {
		e.preventDefault();
		e.stopPropagation();
		var username = $('#username').val();
		var pwd = $('#pwd').val();
		url = domini_com + "ajax/APPLogin?username=" + username + "&password=" + pwd;
		console.log(url);
		$.ajax({
			url: url,
			success: function(data) {
				// Arriba la resposta
				data = JSON.parse(data);
				console.log(data);
				if (data.success) {
					user_name = data.name;
					user_id = data.user_id;
					entitat_id = data.entitat;
					localStorage.setItem('user_id', user_id);
					localStorage.setItem('user_name', user_name);
					localStorage.setItem('entitat_id', entitat_id);
					login();
				}
				else { alert(data.msg); }
			}
		});
	});
	
}

{ // Project page
	$( "#projects-page" ).on( "pageshow", function( e ) {
		$(this).find('h4').text(__("Projectes de") + " " + user_name);
		{ // Demanem la llista de competències
			if ((comps_masc == null) || (comps_fem == null) || (comps_groups == null) || (comps_millora == null) || (emocions == null)) {
				$.ajax({
					// TODO: Enviar l'idioma en funció del particular
					url: domini_intra + "/assets/php/ajax/ajax_return_competences.php?lang=" + lang + "&id=" + entitat_id,
					success: function(data) {
						// Arriba la resposta
						data = JSON.parse(data);
						if (data.success) {
							comps_masc = data.comps_masc;
							comps_fem = data.comps_fem;
							comps_groups = data.groups;
							comps_millora = data.comps_millora;
							emocions = data.emocions;
							//comps_groups = data;
							console.log(data);
							localStorage.setItem('comps_masc', JSON.stringify(comps_masc));
							localStorage.setItem('comps_fem', JSON.stringify(comps_fem));
							localStorage.setItem('comps_groups', JSON.stringify(comps_groups));
							localStorage.setItem('comps_millora', JSON.stringify(comps_millora));
							localStorage.setItem('emocions', JSON.stringify(emocions));
							build_comps_filter();
						}
					}
				});
			}
			else {
				build_comps_filter();
			}
		}

		$.ajax({
			url: domini_com + "ajax/getProjectsByTutor?tutor_id=" + user_id,
			success: function(data) {
				data = JSON.parse(data);
				if (data.success) {
					list = $("#project-list");
					list.empty();
					if (data.projects.length == 1) {
						// Assignar projecte tutor
						project_id = data.projects[0].id;
						project_name = data.projects[0].name;
						$.mobile.navigate("#students-page");
					}
					else {
						data.projects.forEach(function (project, index) {
							var list_item = $('<li><a data-id="' + project.id + '">' + project.name + '</a></li>');
							list.append(list_item).listview('refresh');
						});
					}
				}
				else { alert(data.msg); }
			}
		});
	});

	$(document).on('click', "#project-list li a",function () {
		project_id = $(this).data('id');
		localStorage.setItem('project_id', project_id);
		project_name = $(this).text();
		localStorage.setItem('project_name', project_name);
		$.mobile.navigate("#students-page");
	});
}

{ // Students page
	$("#students-page").on( "pageshow", function( e ) {
		$(this).find('h4').text(__("Estudiants de") + " " + project_name);
		$.ajax({
			url: domini_com + "ajax/getUsersByProjectNTutor?tutor_id=" + user_id + "&project_id=" + project_id,
			success: function(data) {
				// Arriba la resposta
				data = JSON.parse(data);
				if (data.success) {
					list = $("#student-list");
					list.empty();
					nstudents = data.users.length;
					if (nstudents == 1) {
						console.log(data);
						student_id = data.users[0].id;
						student_sex = data.users[0].sex;
						student_name = data.users[0].name + ' ' + data.users[0].lastname;
						$.mobile.navigate("#selector-page");
					}
					else {
						data.users.forEach(function (user, index) {
							var list_item = $('<li><a data-id="' + user.id + '" data-sex="' + user.sex + '">' + user.name + ' ' + user.lastname + '</a></li>');
							list.append(list_item).listview('refresh');
						});
					}
				}
				else { alert(data.msg); }
			}
		});
	});

	$(document).on('click', "#student-list li a",function () {
		student_id = $(this).data('id');
		student_sex = $(this).data('sex');
		student_name = $(this).text();
		$.mobile.navigate("#selector-page");
	});
}

{ // Selector page
	$("#selector-page").on( "pageshow", function( e ) {
		$(this).find('h4').text(__("Alumne") + " " + student_name);					
	});
}

{ // Comps page
	$("#comps-page").on( "pageshow", function( e ) {
		$("#footer").hide();
		$(this).find('h4').text(__("Competències de") + " " + student_name);
		build_comp_list();
	});

	$(document).on('click', "#comps-list li a",function () {
		comp_id = $(this).data('id');
		comp_name = $(this).text();
		$('#comps-popup').popup('open');
		$('#comps-popup p').text(comp_name + ": " + __("PopupComps") + " " + student_name + '?');
	});
	
	$(document).on('click', "#si-comp",function () {
		update_comp(1);
	});
	
	$(document).on('click', "#no-comp",function () {
		$("#footer").hide();
		update_comp(0);
		$("#comps-popup").popup('close');
	});

	{ //Coses rares comentades...
		$(document).on('change', "#filter-cg input", function () {
			id = $(this).data('id');
			if(this.checked) {
				current_groups.push(id);
			}
			else {
				current_groups.splice(current_groups.indexOf(id), 1);
			}
			build_comp_list();
		});
		
		/*$(document).on('swipeleft swiperight', "#comps-list li", function (e) {
			e.stopPropagation();
			// e.preventDefault();
			comp_id = $(this).data('id');
			comp_name = $(this).text();
			console.log(e.type);
			console.log(e);
			if(e.type == "swipeleft") {
				console.log(e.swipestart);
			}
			else if (e.type == "swiperight") {
				console.log(e.swipestop.coords[0] - e.swipestart.coords[0]);
			}
			
		});*/
	}
}

{ // Comps_millora page
	$("#comps_millora-page").on( "pageshow", function( e ) {
		$("#footer").hide();
		$(this).find('h4').text(__("Competències de millora de") + " " + student_name);
		build_comp_millora_list();
	});

	$(document).on('click', "#comps_millora-list li a",function () {
		comp_id = $(this).data('id');
		comp_name = $(this).text();
		$('#comps_millora-popup').popup('open');
		$('#comps_millora-popup p').text(comp_name + ": " + __("PopupComps") + " " + student_name + '?');
	});
	
	$(document).on('click', "#si-comp_millora",function () {
		update_comp_millora(1);
	});
	
	$(document).on('click', "#no-comp_millora",function () {
		update_comp_millora(0);
	});

}

{ // Intels page
	$("#intels-page").on( "pageshow", function( e ) {
		$(".intel-slider[type='number']").each(function(e) {
			$(this).hide();
		});
		
		$(this).find('h4').text(__("Intel·ligències de") + " " + student_name);
		
		{ // Carreguem els sliders amb els valors correctes
			url = domini_intra + "/assets/php/ajax/schools_get_intels.php?pro=" + project_id + "&id_user=" + student_id + "&id_tutor=" + user_id;
			$.ajax({
				url: url,
				success: function(data) {
					data = JSON.parse(data);
					console.log(data);
					if (data.success) {
						$("input.intel-slider").each(function( index ) {
							$(this).val(parseInt(data[index])).slider('refresh');
							$(this).trigger('change');
						});
					}
					else {  
					}
				}
			});
		}
	});
	
	{ // Quan es canvia el nivell de l'slider canvia també l'etiqueta
		$(document).on('change', ".intel-slider",function (e) {
			e.preventDefault();
			level = parseInt($(this).val());
			levels = $(this).data('levels');
			levels = levels.split('|');
			if ($(this).get(0).id != "slider-interpersonal") level += 2;
			$(this).parent().prev().find('span').text(levels[level]);
		});
	}
	
	{ // Quan es canvia el nivell de l'slider es canvia el número a la base de dades
		$(document).on('slidestop', ".intel-slider",function (e) {
			e.preventDefault();
			level = $(this).val();
			id_intel = $(this).data('id_intel');
			levels = $(this).data('levels');
			levels = levels.split('|');
			url = domini_intra + "/assets/php/ajax/ajax_change_one_inteligence_inscrit.php?pro=" + project_id + "&id_user=" + student_id + "&nivell=" + level + "&id_tutor=" + user_id + "&id_intel=" + id_intel;
			$.ajax({
				url: url,
				success: function(data) {
					data = JSON.parse(data);
					console.log(data);
				}
			});
		});
	}
	
	
}

{ // Emocions page
	$("#emocions-page").on( "pageshow", function( e ) {
		$(this).find('h4').text(__("Emocions de") + " " + student_name);;
		build_emocions_list();
		
	});

	$(document).on('click', "#emocions-list li a",function () {
		comp_id = $(this).data('id');
		comp_name = $(this).text();
		$('#emocions-popup').popup('open');
		$('#emocions-popup p').text(comp_name + ": " + __("PopupComps") + " " + student_name + '?');
	});
	
	$(document).on('click', "#si-emocions",function () {
		update_emocions(1);
	});
	
	$(document).on('click', "#no-emocions",function () {
		$("#footer-emocions").hide();
		update_emocions(0);
		$("#emocions-popup").popup('close');
	});
}

function login() {
	if(project_id != null){
		$.mobile.navigate( "#students-page" );
	}
	else {
		$.mobile.navigate( "#projects-page" );
	}
}

function logout() {
	$('#logout-popup').popup('open');
}

function goback() {
	parent.history.back();
	return false;
}

function build_comp_list() {
	list = "";
	if (!student_sex) {
		comps_masc.forEach(function (comp, index) {
			if(current_groups.indexOf(parseInt(comp.group)) > -1 || current_groups.length == 0) {
				list = list + '<li><a data-id="' + comp.id + '">' + comp.name + '</a></li>';
			}
		});
	}
	else {
		comps_fem.forEach(function (comp, index) {
			if(current_groups.indexOf(parseInt(comp.group)) > -1 || current_groups.length == 0) {
				list = list + '<li><a data-id="' + comp.id + '">' + comp.name + '</a></li>';
			}
		});
	}
	
	$("#comps-list").html(list).listview('refresh');
}

function build_comp_millora_list() {
	list_millora = "";
	comps_millora.forEach(function (comp, index) {
		if(current_groups.indexOf(comp.id) > 0 || current_groups.length == 0) {
			list_millora = list_millora + '<li><a data-id="' + comp.id + '">' + comp.name + '</a></li>';
		}
	});

	$("#comps_millora-list").html(list_millora).listview('refresh'); // No es pot inicialitzar abans de crear-lo
}

function build_emocions_list() {
	list_emocions = "";
	console.log(emocions);
	emocions.forEach(function (emocio, index) {
		if(current_groups.indexOf(emocio.id) > 0 || current_groups.length == 0) {
			list_emocions += '<li><a data-id="' + emocio.id + '">' + emocio.name + '</a></li>';
		}
	});

	$("#emocions-list").html(list_emocions).listview('refresh'); // No es pot inicialitzar abans de crear-lo
}

function build_comps_filter() {
	filter_buttons = "";
	comps_groups.forEach(function (comp, index) {
		filter_buttons = filter_buttons + '<input type="checkbox" data-id="' + comp.id + '" id="checkbox-' + comp.name + '"><label for="checkbox-' + comp.name + '">' + comp.name + '</label>';
	});
	$("#filter-cg").html(filter_buttons);
	$("#comps-page").trigger('create');
}

function update_comp(v) {
	url = domini_intra + "/assets/php/ajax/ajax_change_competence.php?t=" + user_id + "&p=" + project_id + "&c=" + comp_id + "&v=" + v + "&id=" + student_id;
	$.ajax({
		url: url,
		success: function(data) {
			data = JSON.parse(data);
			console.log(data);
			if (data.success) {
				$("#comps-popup").popup('close');
				$("#comps-footer").show( 400 );
				console.log(8);
				setTimeout(
				  function() 
				  {
					$("#comps-footer").hide( 400 );
				  }, 3000);
			}
			else { alert(data.msg);
			}
		}
	});
}

function update_comp_millora(v) {
	url = domini_intra + "/assets/php/ajax/ajax_change_competence_cm.php?t=" + user_id + "&p=" + project_id + "&c=" + comp_id + "&v=" + v + "&id=" + student_id;
	$.ajax({
		url: url,
		success: function(data) {
			data = JSON.parse(data);
			if (data.success) {
				$("#comps_millora-popup").popup('close');
				$("#comp_millora-footer").show( 400 );
				console.log(data);
				setTimeout(
				 
				function() {
					$("#comp_millora-footer").hide( 400 );
				}, 3000);
				
			}
			else {
				alert(data.msg);
				$("#comps_millora-popup").popup('close');
			}
		}
	});
}

function update_emocions(v) {
	url = domini_intra + "/assets/php/ajax/ajax_change_emocio.php?t=" + user_id + "&p=" + project_id + "&c=" + comp_id + "&v=" + v + "&id=" + student_id;
	$.ajax({
		url: url,
		success: function(data) {
			data = JSON.parse(data);
			if (data.success) {
				$("#emocions-popup").popup('close');
				$("#footer-emocions").show( 400 );
				setTimeout(
				 
				function() {
					$("#footer-emocions").hide( 400 );
				}, 3000);
				
			}
			else {
				alert(data.msg);
				$("#emocions-popup").popup('close');
			}
		}
	});
}

function sync() {
	$.ajax({
		// TODO: Enviar l'idioma en funció del particular
		url: domini_intra + "/assets/php/ajax/ajax_return_competences.php?lang=" + lang + "&id=" + entitat_id,
		success: function(data) {
			// Arriba la resposta
			data = JSON.parse(data);
			if (data.success) {
				comps_masc = data.comps_masc;
				comps_fem = data.comps_fem;
				comps_groups = data.groups;
				comps_millora = data.comps_millora;
				emocions = data.emocions;
				//comps_groups = data;
				console.log(data);
				localStorage.setItem('comps_masc', JSON.stringify(comps_masc));
				localStorage.setItem('comps_fem', JSON.stringify(comps_fem));
				localStorage.setItem('comps_groups', JSON.stringify(comps_groups));
				localStorage.setItem('comps_millora', JSON.stringify(comps_millora));
				localStorage.setItem('emocions', JSON.stringify(emocions));
				build_comps_filter();
				$("#rightpanel").panel("close");
			}
		}
	});
}

function exit() {
	console.log("yeeye");
	navigator.app.exitApp();
}

$(document).on('click', ".goback_btn", goback);

$(document).on('click', ".si-logout",function () {
	console.log('Clear localStorage and exit');
	localStorage.removeItem('user_id');
	localStorage.removeItem('user_name');
	localStorage.clear();
	$.mobile.navigate( "#login-page" );
});

$(".comp-popup").on("popupafterclose", function(){
	$("#success-popup").popup('open');
});

function showLocalStorage() {
	for (var i = 0; i < localStorage.length; i++){
		console.log(localStorage.getItem[i]);
	}
	console.log(localStorage.getItem('user_id'));
	console.log(localStorage.getItem('project_id'));
}

function __(text) {
	if(text in i18n){
		if(lang in i18n[text])return i18n[text][lang];
	} 
	else return text;
}
</script>